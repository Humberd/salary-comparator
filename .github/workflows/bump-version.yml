name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: get_version
        run: |
          VERSION_NAME=$(grep -oP 'versionName "\K[^"]+' app/build.gradle)
          VERSION_CODE=$(grep -oP 'versionCode \K\d+' app/build.gradle)
          echo "current_version=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "current_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION_NAME (code: $VERSION_CODE)"

      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          CURRENT_CODE="${{ steps.get_version.outputs.current_code }}"
          BUMP_TYPE="${{ inputs.bump_type }}"
          
          # Parse semantic version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          # Bump version based on type
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_CODE=$((CURRENT_CODE + 1))
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION (code: $NEW_CODE)"

      - name: Update build.gradle
        run: |
          sed -i 's/versionCode ${{ steps.get_version.outputs.current_code }}/versionCode ${{ steps.calc_version.outputs.new_code }}/' app/build.gradle
          sed -i 's/versionName "${{ steps.get_version.outputs.current_version }}"/versionName "${{ steps.calc_version.outputs.new_version }}"/' app/build.gradle
          
          echo "Updated build.gradle:"
          grep -E 'versionCode|versionName' app/build.gradle

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/build.gradle
          git commit -m "Bump version to ${{ steps.calc_version.outputs.new_version }}"
          git push

      - name: Create and push tag
        run: |
          TAG="v${{ steps.calc_version.outputs.new_version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created and pushed tag: $TAG"

